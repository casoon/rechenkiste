---
import { ClientRouter } from "astro:transitions";
import "@styles/base.css";
import type { Locale } from "@i18n/translations";
import { t, getLocalizedPath } from "@i18n/translations";

interface Props {
    title: string;
    locale?: Locale;
    description?: string;
}

const { title, locale = "de", description } = Astro.props;

const siteUrl = "https://rechenkiste.casoon.workers.dev";
const currentUrl = `${siteUrl}${Astro.url.pathname}`;

// SEO Descriptions per locale
const seoDescriptions = {
    de: "Kostenlose Mathe-√úbungen f√ºr Grundschulkinder. Rechnen, Geometrie und Textaufgaben f√ºr Klasse 1-5. Interaktiv und kindgerecht.",
    en: "Free math exercises for elementary school children. Arithmetic, geometry and word problems for grades 1-5. Interactive and child-friendly.",
    uk: "–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω—ñ –≤–ø—Ä–∞–≤–∏ –¥–ª—è –¥—ñ—Ç–µ–π –ø–æ—á–∞—Ç–∫–æ–≤–æ—ó —à–∫–æ–ª–∏. –ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞, –≥–µ–æ–º–µ—Ç—Ä—ñ—è —Ç–∞ —Ç–µ–∫—Å—Ç–æ–≤—ñ –∑–∞–¥–∞—á—ñ –¥–ª—è 1-5 –∫–ª–∞—Å—ñ–≤.",
};

const metaDescription = description || seoDescriptions[locale];
const fullTitle = `${title} - ${t(locale, "appName")}`;

const locales: { code: Locale; label: string; flag: string }[] = [
    { code: "de", label: "Deutsch", flag: "üá©üá™" },
    { code: "en", label: "English", flag: "üá¨üáß" },
    { code: "uk", label: "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞", flag: "üá∫üá¶" },
];

const currentPath = Astro.url.pathname.replace(/^\/(en|uk)/, "") || "/";
---

<!doctype html>
<html lang={locale}>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- SEO Meta Tags -->
        <title>{fullTitle}</title>
        <meta name="description" content={metaDescription} />
        <meta name="keywords" content="Mathe, Mathematik, Grundschule, Kinder, Rechnen, √úbungen, Klasse 1-5, kostenlos, interaktiv" />
        <meta name="author" content="casoon.de" />
        <meta name="robots" content="index, follow" />
        <link rel="canonical" href={currentUrl} />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={currentUrl} />
        <meta property="og:title" content={fullTitle} />
        <meta property="og:description" content={metaDescription} />
        <meta property="og:image" content={`${siteUrl}/icons/icon-512.svg`} />
        <meta property="og:locale" content={locale === "de" ? "de_DE" : locale === "en" ? "en_US" : "uk_UA"} />
        <meta property="og:site_name" content={t(locale, "appName")} />

        <!-- Twitter -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:title" content={fullTitle} />
        <meta name="twitter:description" content={metaDescription} />
        <meta name="twitter:image" content={`${siteUrl}/icons/icon-512.svg`} />

        <!-- Favicon & App Icons -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="apple-touch-icon" href="/icons/icon-192.svg" />
        <link rel="manifest" href="/manifest.json" />
        <meta name="theme-color" content="#8B5CF6" />

        <!-- Mobile App Meta -->
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="apple-mobile-web-app-title" content={t(locale, "appName")} />
        <meta name="application-name" content={t(locale, "appName")} />

        <!-- Language alternates -->
        <link rel="alternate" hreflang="de" href={`${siteUrl}/`} />
        <link rel="alternate" hreflang="en" href={`${siteUrl}/en/`} />
        <link rel="alternate" hreflang="uk" href={`${siteUrl}/uk/`} />
        <link rel="alternate" hreflang="x-default" href={`${siteUrl}/`} />

        <!-- Structured Data (JSON-LD) -->
        <script type="application/ld+json" set:html={JSON.stringify({
            "@context": "https://schema.org",
            "@type": "WebApplication",
            "name": t(locale, "appName"),
            "description": metaDescription,
            "url": siteUrl,
            "applicationCategory": "EducationalApplication",
            "operatingSystem": "Any",
            "offers": {
                "@type": "Offer",
                "price": "0",
                "priceCurrency": "EUR"
            },
            "audience": {
                "@type": "EducationalAudience",
                "educationalRole": "student",
                "suggestedMinAge": 6,
                "suggestedMaxAge": 12
            },
            "inLanguage": [locale],
            "author": {
                "@type": "Organization",
                "name": "casoon.de",
                "url": "https://www.casoon.de"
            }
        })} />

        <ClientRouter />
        <script is:inline src="https://unpkg.com/htmx.org@2.0.4"></script>
        <script
            is:inline
            defer
            src="https://unpkg.com/alpinejs@3.14.0/dist/cdn.min.js"></script>
        <script is:inline>
            // Re-initialize HTMX after View Transitions
            document.addEventListener("astro:page-load", () => {
                if (window.htmx) {
                    htmx.process(document.body);
                }
            });
        </script>
    </head>
    <body class="min-h-screen">
        <div class="min-h-screen flex flex-col">
            <!-- Header -->
            <header class="p-4">
                <div
                    class="max-w-4xl mx-auto flex justify-between items-center"
                >
                    <a
                        href={getLocalizedPath("/", locale)}
                        class="flex items-center gap-3 group"
                    >
                        <span class="text-4xl">üßÆ</span>
                        <span
                            class="text-2xl font-bold text-purple-700 group-hover:text-purple-900 transition-colors"
                        >
                            {t(locale, "appName")}
                        </span>
                    </a>

                    <!-- Language Switcher -->
                    <nav
                        class="language-switcher"
                        aria-label={t(locale, "language")}
                    >
                        {
                            locales.map((loc) => (
                                <a
                                    href={getLocalizedPath(
                                        currentPath,
                                        loc.code,
                                    )}
                                    class:list={[
                                        "language-btn",
                                        { active: locale === loc.code },
                                    ]}
                                    aria-current={
                                        locale === loc.code ? "page" : undefined
                                    }
                                >
                                    <span class="mr-1">{loc.flag}</span>
                                    <span class="hidden sm:inline">
                                        {loc.label}
                                    </span>
                                </a>
                            ))
                        }
                    </nav>
                </div>
            </header>

            <!-- Main Content -->
            <main
                class="flex-1 flex items-center justify-center p-4"
                transition:animate="fade"
            >
                <slot />
            </main>

            <!-- Footer -->
            <footer class="p-4 text-center text-gray-600 text-sm space-y-2">
                <p>Made with ‚ù§Ô∏è for kids</p>
                <p class="flex items-center justify-center gap-4">
                    <a
                        href="https://www.casoon.de"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="hover:text-purple-600 transition-colors"
                    >
                        casoon.de
                    </a>
                    <span class="text-gray-300">|</span>
                    <a
                        href={getLocalizedPath("/technik", locale)}
                        class="hover:text-purple-600 transition-colors"
                    >
                        {t(locale, "techInfo")}
                    </a>
                    <span class="text-gray-300">|</span>
                    <span
                        id="load-counter"
                        class="text-gray-400 font-mono text-xs cursor-help"
                        title="F = Fragment-Loads (HTMX), P = Page-Loads (Browser). Mehr Fragments = schnellere App!"
                        hx-get="/api/test/counter"
                        hx-trigger="load, taskLoaded from:body, feedbackShown from:body"
                        hx-swap="innerHTML"></span>
                </p>
            </footer>
        </div>
    </body>
</html>
