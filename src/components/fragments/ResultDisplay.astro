---
import { t, getLocalizedPath } from "@i18n/translations";
import type { Locale } from "@i18n/translations";
import type { TestSession } from "@domain/session";

interface ResultData {
    correct: number;
    total: number;
    percent: number;
    results: Array<{
        isCorrect: boolean;
        userAnswer: string | number;
        correctAnswer: string | number;
    }>;
    tasks: Array<{
        category: string;
        question: string;
        data: { story?: string };
    }>;
}

interface Props {
    locale: Locale;
    session: TestSession;
    resultData: ResultData;
}

const { locale, session, resultData } = Astro.props;
const { correct, total, percent, results, tasks } = resultData;

// Determine feedback message based on percentage
let feedbackKey: "excellent" | "great" | "good" | "keepPracticing";
let stars: number;

if (percent >= 90) {
    feedbackKey = "excellent";
    stars = 5;
} else if (percent >= 70) {
    feedbackKey = "great";
    stars = 4;
} else if (percent >= 50) {
    feedbackKey = "good";
    stars = 3;
} else {
    feedbackKey = "keepPracticing";
    stars = 2;
}
---

<div class="glass-card-strong p-6 md:p-10 max-w-2xl w-full mx-auto">
    <!-- Result Header -->
    <div class="text-center mb-8 bounce-in">
        <h1 class="text-3xl md:text-4xl font-bold text-purple-700 mb-4">
            {t(locale, "result")}
        </h1>

        <!-- Stars -->
        <div class="flex justify-center gap-1 mb-4">
            {
                Array.from({ length: 5 }).map((_, i) => (
                    <span class="star" style={`animation-delay: ${i * 0.1}s`}>
                        {i < stars ? "⭐" : "☆"}
                    </span>
                ))
            }
        </div>

        <!-- Score -->
        <div class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">
            {t(locale, "youSolved", { correct, total })}
        </div>
        <div class="text-xl text-purple-600 font-bold">
            {t(locale, "percent", { percent })}
        </div>
    </div>

    <!-- Progress Circle -->
    <div class="flex justify-center mb-8">
        <div class="relative w-40 h-40">
            <svg
                class="w-full h-full transform -rotate-90"
                viewBox="0 0 100 100"
            >
                <circle
                    cx="50"
                    cy="50"
                    r="45"
                    fill="none"
                    stroke="#e5e7eb"
                    stroke-width="8"></circle>
                <circle
                    cx="50"
                    cy="50"
                    r="45"
                    fill="none"
                    stroke="url(#gradient)"
                    stroke-width="8"
                    stroke-linecap="round"
                    stroke-dasharray={`${percent * 2.83} 283`}
                    class="transition-all duration-1000 ease-out"></circle>
                <defs>
                    <linearGradient
                        id="gradient"
                        x1="0%"
                        y1="0%"
                        x2="100%"
                        y2="0%"
                    >
                        <stop offset="0%" stop-color="#22c55e"></stop>
                        <stop offset="100%" stop-color="#10b981"></stop>
                    </linearGradient>
                </defs>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-3xl font-bold text-gray-800">{percent}%</span>
            </div>
        </div>
    </div>

    <!-- Feedback Message -->
    <div class="text-center mb-8 slide-up">
        <p class="text-xl text-gray-700">
            {t(locale, feedbackKey)}
        </p>
    </div>

    <!-- Error Details (Alpine.js toggle) -->
    <div x-data="{ showErrors: false }" class="mb-8">
        {
            results.some((r) => !r.isCorrect) && (
                <>
                    <button
                        @click="showErrors = !showErrors"
                        class="btn-secondary w-full mb-4"
                    >
                        <span
                            x-text={`showErrors ? '${t(locale, "hideErrors")}' : '${t(locale, "showErrors")}'`}
                        />
                    </button>

                    <div x-show="showErrors" x-transition class="space-y-3">
                        {results.map((result, index) => {
                            if (result.isCorrect) return null;
                            const task = tasks[index];
                            return (
                                <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-left">
                                    <p class="font-bold text-gray-800 mb-2">
                                        {task.category === "word-problem"
                                            ? task.data.story
                                            : task.question}
                                    </p>
                                    <p class="text-red-600">
                                        {t(locale, "yourAnswerWas", {
                                            answer: result.userAnswer,
                                        })}
                                    </p>
                                    <p class="text-green-600">
                                        {t(locale, "correctAnswer", {
                                            answer: result.correctAnswer,
                                        })}
                                    </p>
                                </div>
                            );
                        })}
                    </div>
                </>
            )
        }
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a
            href={getLocalizedPath(
                `/?grade=${session.grade}&count=${session.totalTasks}`,
                locale,
            )}
            class="btn-primary"
        >
            {t(locale, "tryAgain")}
        </a>
        <a href={getLocalizedPath("/", locale)} class="btn-secondary">
            {t(locale, "backToStart")}
        </a>
    </div>
</div>
